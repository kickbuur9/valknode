apiVersion: apps/v1
kind: Deployment
metadata:
  name: fleet-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fleet-server
  template:
    metadata:
      labels:
        app: fleet-server
    spec:
      automountServiceAccountToken: false
      containers:
      - name: elastic-agent
        image: docker.elastic.co/beats/elastic-agent:8.19.0 #9.1.0
        env:
          - name: FLEET_SERVER_ENABLE
            value: "true"
          - name: FLEET_SERVER_ELASTICSEARCH_HOST
            valueFrom:
              secretKeyRef:
                name: fleet-server-config
                key: elastic_endpoint
          - name: FLEET_SERVER_SERVICE_TOKEN
            valueFrom:
              secretKeyRef:
                name: fleet-server-config
                key: elastic_service_token
          - name: FLEET_SERVER_POLICY_ID
            valueFrom:
              secretKeyRef:
                name: fleet-server-config
                key: fleet_policy_id
          - name: FLEET_SERVER_CERT
            value: /mnt/certs/tls.crt
          - name: FLEET_SERVER_CERT_KEY
            value: /mnt/certs/tls.key
          - name: FLEET_URL
            valueFrom:
              secretKeyRef:
                name: fleet-server-ssl
                key: fleet_url
          - name: FLEET_SERVER_TIMEOUT
            value: "60s"
          - name: FLEET_SERVER_PORT
            value: "8220"
        ports:
        - containerPort: 8220
          protocol: TCP
        volumeMounts:
        - name: certs
          mountPath: /mnt/certs
          readOnly: true
      volumes:
      - name: certs
        secret:
          secretName: fleet-server-ssl

