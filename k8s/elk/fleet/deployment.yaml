apiVersion: apps/v1
kind: Deployment
metadata:
  name: fleet-server
  namespace: elastic
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fleet-server
  template:
    metadata:
      labels:
        app: fleet-server
    spec:
      securityContext:
        fsGroup: 0
        runAsUser: 0
      containers:
        - name: fleet-server
          image: docker.elastic.co/elastic-agent/elastic-agent:9.2.3
          env:
            - name: FLEET_ENROLL
              value: "1"
            - name: FLEET_SERVER_ENABLE
              value: "1"

            # Fleet bind settings
            - name: FLEET_SERVER_HOST
              value: "0.0.0.0"
            - name: FLEET_SERVER_PORT
              value: "8220"

            # Policy and tokens
            - name: FLEET_SERVER_POLICY_ID
              value: "fleet-server-policy"
            - name: FLEET_SERVER_SERVICE_TOKEN
              value: "AAEAAWVsYXN0aWMvZmxlZXQtc2VydmVyL2ZsZWV0LXNlcnZlci10b2tlbjplMkgwaWxqR1RYSzg2OVdOUVlJZUZn"

            # Explicitly use port 443 for the Ingress
            - name: FLEET_URL
              value: "https://fleet-server.kickb.dev:443"

            # Enrollment token
            - name: FLEET_ENROLLMENT_TOKEN
              value: "TFhFYlpac0I5TWY3bVBQRVVyNnM6N3dlR1E2ZUIwV080WDNXRkhTcnNmZw=="

            # Public Kibana URL
            - name: KIBANA_HOST
              value: "https://kibana.kickb.dev:443"

            - name: KIBANA_FLEET_SETUP
              value: "true"
            - name: FLEET_SERVER_INSECURE_HTTP
              value: "true"

            # FIX: Added :443 to the host URL
            # - name: FLEET_SERVER_ELASTICSEARCH_HOST
            #   value: "https://elasticsearch.kickb.dev:443"
            - name: FLEET_SERVER_ELASTICSEARCH_HOST
              value: "http://elasticsearch:9200"

            # Required if the agent cannot verify the Let's Encrypt CA internally
            - name: FLEET_SERVER_ELASTICSEARCH_INSECURE
              value: "true"
            - name: FLEET_INSECURE
              value: "true"